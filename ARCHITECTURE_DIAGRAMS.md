# Indexer-RS Architecture Diagrams (ASCII Art)

This document contains ASCII art diagrams representing the complete architecture of the Indexer-RS system.

---

## 1. High-Level System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BLOCKCHAIN NETWORKS                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Ethereum   │  │   Polygon    │  │     BSC      │  │     Base     │   │
│  │   Mainnet    │  │              │  │              │  │              │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│         │                  │                  │                  │            │
│         └──────────────────┴──────────────────┴──────────────────┘            │
│                                    │                                            │
│                                    │ RPC Calls (HTTP/WebSocket)                 │
│                                    ▼                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          INDEXER-RS SYSTEM                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        LISTENER SERVICE                                   │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                           │ │
│  │  ┌──────────────────┐         ┌──────────────────┐                    │ │
│  │  │  Listener Binary │         │   RPC Client      │                    │ │
│  │  │                  │◄────────│   (Alloy Provider)│                    │ │
│  │  │  - Main Loop     │         │                   │                    │ │
│  │  │  - Rate Limiter  │         │  - HTTP/WS Client │                    │ │
│  │  │  - Task Spawner  │         │  - Filter Builder │                    │ │
│  │  └────────┬─────────┘         └───────────────────┘                    │ │
│  │           │                                                             │ │
│  │           │                                                             │ │
│  │  ┌────────▼─────────┐                                                   │ │
│  │  │  Sync Manager    │                                                   │ │
│  │  │                  │                                                   │ │
│  │  │  - Track Progress│                                                   │ │
│  │  │  - Block Range   │                                                   │ │
│  │  │  - Deployment    │                                                   │ │
│  │  │    Detection     │                                                   │ │
│  │  └────────┬─────────┘                                                   │ │
│  │           │                                                             │ │
│  └───────────┼─────────────────────────────────────────────────────────────┘ │
│              │                                                               │
│              │ Store Raw Logs                                               │
│              │                                                               │
│  ┌───────────▼───────────────────────────────────────────────────────────┐ │
│  │                      DATABASE LAYER                                     │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌──────────────────┐         ┌──────────────────┐                     │ │
│  │  │  indexer-db     │         │  Connection Pool │                     │ │
│  │  │  Library        │◄────────│                  │                     │ │
│  │  │                 │         │  - Pool Size: 5  │                     │ │
│  │  │  - Entities     │         │  - Reuse Conns   │                     │ │
│  │  │  - Queries      │         │  - Transaction   │                     │ │
│  │  │  - Migrations   │         │    Management    │                     │ │
│  │  └────────┬────────┘         └──────────────────┘                     │ │
│  │           │                                                             │ │
│  └───────────┼─────────────────────────────────────────────────────────────┘ │
│              │                                                               │
│              │ Read/Write                                                    │
│              │                                                               │
│  ┌───────────▼───────────────────────────────────────────────────────────┐ │
│  │                    POSTGRESQL DATABASE                                 │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │ │
│  │  │   evm_logs       │  │ evm_sync_logs    │  │ evm_chains        │  │ │
│  │  │                  │  │                  │  │                  │  │ │
│  │  │  - Raw Events    │  │  - Sync State    │  │  - Chain Config   │  │ │
│  │  │  - Unprocessed   │  │  - Block Number  │  │  - Block Time     │  │ │
│  │  │  - Temporary     │  │  - Block Hash   │  │  - Chain ID      │  │ │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │ │
│  │                                                                         │ │
│  │  ┌──────────────────┐                                                  │ │
│  │  │ usdt_transfers  │                                                  │ │
│  │  │                 │                                                  │ │
│  │  │  - Processed    │                                                  │ │
│  │  │  - Final Data   │                                                  │ │
│  │  │  - Indexed      │                                                  │ │
│  │  └──────────────────┘                                                  │ │
│  │                                                                         │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│              │                                                               │
│              │ Query Unprocessed Logs                                       │
│              │                                                               │
│  ┌───────────▼───────────────────────────────────────────────────────────┐ │
│  │                        PROCESSOR SERVICE                               │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │                                                                         │ │
│  │  ┌──────────────────┐         ┌──────────────────┐                 │ │
│  │  │ Processor Binary │         │ Contract Registry │                 │ │
│  │  │                  │         │                   │                 │ │
│  │  │  - Polling Loop  │         │  - Address Map    │                 │ │
│  │  │  - Batch Process│◄────────│  - Handler Lookup │                 │ │
│  │  │  - Concurrent   │         │  - ABI Loading    │                 │ │
│  │  └────────┬─────────┘         └───────────────────┘                 │ │
│  │           │                                                           │ │
│  │           │                                                           │ │
│  │  ┌────────▼───────────────────────────────────────┐                 │ │
│  │  │         Event Handlers                         │                 │ │
│  │  │                                                 │                 │ │
│  │  │  ┌──────────────┐  ┌──────────────┐           │                 │ │
│  │  │  │ USDT ERC20   │  │  Future      │           │                 │ │
│  │  │  │ Handler      │  │  Handlers    │           │                 │ │
│  │  │  │              │  │              │           │                 │ │
│  │  │  │ - Transfer   │  │ - ERC721     │           │                 │ │
│  │  │  │ - Approval   │  │ - ERC1155    │           │                 │ │
│  │  │  │ - ABI Parse  │  │ - Custom     │           │                 │ │
│  │  │  └──────────────┘  └──────────────┘           │                 │ │
│  │  └───────────────────────────────────────────────┘                 │ │
│  │                                                                       │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Component Interaction Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          LISTENER SERVICE FLOW                               │
└──────────────────────────────────────────────────────────────────────────────┘

    START
      │
      ▼
┌─────────────────┐
│ Initialize DB   │
│ Connection Pool │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Load Env Vars   │
│ - CHAIN_ID      │
│ - CONTRACT_ADDR │
│ - RPC_URL       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Fetch Chain     │
│ Config from DB  │
│ (block_time)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Create Service  │
│ per Contract    │
│ (Rate Limited)  │
└────────┬────────┘
         │
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌─────────┐
│Contract │ │Contract │  ... (N contracts)
│Addr 1   │ │Addr 2   │
└────┬────┘ └────┬────┘
     │           │
     │           │
     └─────┬─────┘
           │
           │ Concurrent Tasks
           │
           ▼
    ┌─────────────────────────────────────┐
    │     LISTENER SERVICE LOOP            │
    │                                      │
    │  ┌──────────────────────────────┐   │
    │  │ 1. Get Sync State            │   │
    │  │    (from evm_sync_logs)      │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 2. Get Latest Block          │   │
    │  │    (RPC: eth_blockNumber)    │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 3. Calculate Block Range     │   │
    │  │    - If first sync:          │   │
    │  │      Find deployment block   │   │
    │  │    - Else:                   │   │
    │  │      last_synced + 1         │   │
    │  │    - Fetch 10 blocks max    │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 4. Fetch Logs from RPC       │   │
    │  │    (RPC: eth_getLogs)        │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 5. BEGIN TRANSACTION         │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 6. For each log:             │   │
    │  │    INSERT INTO evm_logs      │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 7. UPDATE evm_sync_logs      │   │
    │  │    (last_synced_block)       │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 8. COMMIT TRANSACTION        │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             ▼                        │
    │  ┌──────────────────────────────┐   │
    │  │ 9. Sleep (block_time sec)    │   │
    │  └──────────┬───────────────────┘   │
    │             │                        │
    │             └──────────┐            │
    │                         │            │
    │                         ▼            │
    │                  (Loop Back)         │
    └──────────────────────────────────────┘
```

---

## 3. Processor Service Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                         PROCESSOR SERVICE FLOW                              │
└──────────────────────────────────────────────────────────────────────────────┘

    START
      │
      ▼
┌─────────────────┐
│ Initialize DB   │
│ Connection Pool │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Load Config     │
│ - POLL_INTERVAL │
│ - BATCH_SIZE    │
│ - CHAIN_ID      │
│ - CONTRACTS     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Initialize      │
│ Contract        │
│ Registry        │
└────────┬────────┘
         │
         │
         ▼
    ┌─────────────────────────────────────┐
    │     PROCESSOR POLLING LOOP          │
    │                                     │
    │  ┌──────────────────────────────┐  │
    │  │ 1. COUNT unprocessed logs    │  │
    │  │    SELECT COUNT(*)           │  │
    │  │    FROM evm_logs             │  │
    │  │    WHERE is_final = false    │  │
    │  └──────────┬───────────────────┘  │
    │             │                       │
    │             ▼                       │
    │  ┌──────────────────────────────┐  │
    │  │ 2. If count > 0:             │  │
    │  │    Proceed to processing     │  │
    │  │    Else: Sleep POLL_INTERVAL  │  │
    │  └──────────┬───────────────────┘  │
    │             │                       │
    │             ▼                       │
    │  ┌──────────────────────────────┐  │
    │  │ 3. FETCH batch of logs       │  │
    │  │    SELECT * FROM evm_logs    │  │
    │  │    LIMIT BATCH_SIZE          │  │
    │  └──────────┬───────────────────┘  │
    │             │                       │
    │             ▼                       │
    │  ┌──────────────────────────────┐  │
    │  │ 4. For each log (CONCURRENT): │  │
    │  │                               │  │
    │  │    ┌──────────────────────┐  │  │
    │  │    │ a. Get Contract      │  │  │
    │  │    │    Handler from      │  │  │
    │  │    │    Registry          │  │  │
    │  │    └──────────┬───────────┘  │  │
    │  │               │              │  │
    │  │               ▼              │  │
    │  │    ┌──────────────────────┐  │  │
    │  │    │ b. Process Log:      │  │  │
    │  │    │    - Get event name  │  │  │
    │  │    │    - Decode params   │  │  │
    │  │    │    - Handle event    │  │  │
    │  │    └──────────┬───────────┘  │  │
    │  │               │              │  │
    │  │               ▼              │  │
    │  │    ┌──────────────────────┐  │  │
    │  │    │ c. Store Processed  │  │  │
    │  │    │    Data (e.g.,       │  │  │
    │  │    │    usdt_transfers)   │  │  │
    │  │    └──────────┬───────────┘  │  │
    │  │               │              │  │
    │  │               ▼              │  │
    │  │    ┌──────────────────────┐  │  │
    │  │    │ d. DELETE from       │  │  │
    │  │    │    evm_logs          │  │  │
    │  │    └──────────────────────┘  │  │
    │  │                               │  │
    │  └──────────┬───────────────────┘  │
    │             │                       │
    │             ▼                       │
    │  ┌──────────────────────────────┐  │
    │  │ 5. Wait for all tasks        │  │
    │  │    (JoinSet.join_all)        │  │
    │  └──────────┬───────────────────┘  │
    │             │                       │
    │             ▼                       │
    │  ┌──────────────────────────────┐  │
    │  │ 6. Sleep POLL_INTERVAL       │  │
    │  └──────────┬───────────────────┘  │
    │             │                       │
    │             └──────────┐            │
    │                         │            │
    │                         ▼            │
    │                  (Loop Back)         │
    └──────────────────────────────────────┘
```

---

## 4. Complete Data Flow Sequence

```
┌─────────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│ Blockchain  │  │ Listener │  │Database  │  │Processor │  │Registry  │  │ Handler  │
│    Node     │  │ Service  │  │          │  │ Service  │  │          │  │          │
└──────┬──────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
       │              │              │              │              │              │
       │              │              │              │              │              │
       │              │ 1. Initialize DB Pool       │              │              │
       │              │────────────────────────────>│              │              │
       │              │              │              │              │              │
       │              │ 2. Fetch Chain Config       │              │              │
       │              │────────────────────────────>│              │              │
       │              │<────────────────────────────│              │              │
       │              │              │              │              │              │
       │              │ 3. Get/Create Sync Log     │              │              │
       │              │────────────────────────────>│              │              │
       │              │<────────────────────────────│              │              │
       │              │              │              │              │              │
       │              │ 4. Get Latest Block         │              │              │
       │              │────────────────────────────>│              │              │
       │              │<────────────────────────────│              │              │
       │              │              │              │              │              │
       │              │ 5. Calculate Block Range     │              │              │
       │              │              │              │              │              │
       │              │ 6. Fetch Logs               │              │              │
       │              │────────────────────────────>│              │              │
       │              │<────────────────────────────│              │              │
       │              │              │              │              │              │
       │              │ 7. BEGIN TRANSACTION        │              │              │
       │              │────────────────────────────>│              │              │
       │              │              │              │              │              │
       │              │ 8. INSERT evm_logs         │              │              │
       │              │────────────────────────────>│              │              │
       │              │              │              │              │              │
       │              │ 9. UPDATE evm_sync_logs    │              │              │
       │              │────────────────────────────>│              │              │
       │              │              │              │              │              │
       │              │ 10. COMMIT                  │              │              │
       │              │────────────────────────────>│              │              │
       │              │              │              │              │              │
       │              │              │              │              │              │
       │              │              │ 11. COUNT unprocessed      │              │
       │              │              │<───────────────────────────│              │
       │              │              │───────────────────────────>│              │
       │              │              │              │              │              │
       │              │              │ 12. SELECT batch           │              │
       │              │              │<───────────────────────────│              │
       │              │              │───────────────────────────>│              │
       │              │              │              │              │              │
       │              │              │ 13. Get Handler            │              │
       │              │              │              │──────────────>│              │
       │              │              │              │<──────────────│              │
       │              │              │              │              │              │
       │              │              │              │ 14. Process  │              │
       │              │              │              │──────────────>│              │
       │              │              │              │              │              │
       │              │              │              │ 15. Event     │              │
       │              │              │              │    Signature  │              │
       │              │              │              │    to Name    │              │
       │              │              │              │──────────────>│              │
       │              │              │              │<──────────────│              │
       │              │              │              │              │              │
       │              │              │              │ 16. Handle   │              │
       │              │              │              │    Event     │              │
       │              │              │              │──────────────>│              │
       │              │              │              │              │              │
       │              │              │ 17. INSERT usdt_transfers  │              │
       │              │              │<───────────────────────────│              │
       │              │              │───────────────────────────>│              │
       │              │              │              │              │              │
       │              │              │ 18. DELETE evm_logs        │              │
       │              │              │<───────────────────────────│              │
       │              │              │───────────────────────────>│              │
       │              │              │              │              │              │
```

---

## 5. Database Schema (Entity Relationship)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          DATABASE SCHEMA                                     │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────┐
│        evm_chains               │
├──────────────────────────────────┤
│ PK  id              BIGINT       │
│     name            TEXT (UK)    │
│     last_synced_    BIGINT       │
│       block_number               │
│     block_time      INTEGER      │
│     created_at      TIMESTAMP    │
│     updated_at      TIMESTAMP    │
└──────────┬───────────────────────┘
           │
           │ 1:N
           │
           ├──────────────────────────────┐
           │                              │
           │                              │
           ▼                              ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│    evm_sync_logs         │  │    usdt_transfers        │
├──────────────────────────┤  ├──────────────────────────┤
│ PK  address      BYTEA   │  │ PK  id          BIGSERIAL│
│     last_synced_ BIGINT   │  │     tx_hash     BYTEA    │
│       block_number        │  │     block_number NUMERIC │
│     last_synced_ BYTEA    │  │     block_      TIMESTAMP│
│       block_hash          │  │       timestamp          │
│ FK  chain_id     BIGINT───┼──┤     from_address BYTEA    │
│     created_at   TIMESTAMP│  │     to_address  BYTEA    │
│     updated_at   TIMESTAMP│  │     value       NUMERIC   │
└──────────────────────────┘  │     classification SMALLINT│
                              │ FK  chain_id     BIGINT───┼──┐
                              │     created_at   TIMESTAMP│  │
                              └──────────────────────────┘  │
                                                             │
                                                             │
                              ┌──────────────────────────────┘
                              │
                              │
┌──────────────────────────────┐
│        evm_logs              │
├──────────────────────────────┤
│ PK  id              SERIAL   │
│     block_number    NUMERIC  │
│     block_hash      BYTEA    │
│     address         BYTEA    │
│     transaction_    BYTEA    │
│       hash                   │
│     transaction_    BIGINT  │
│       index                   │
│     log_index       BIGINT  │
│     removed         BOOL     │
│     data            BYTEA    │
│     event_signature BYTEA    │
│     topics          BYTEA[]  │
│     is_final        BOOL     │
│     created_at      TIMESTAMP│
└──────────────────────────────┘

Legend:
PK = Primary Key
FK = Foreign Key
UK = Unique Key
```

---

## 6. Deployment Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        DEVELOPMENT ENVIRONMENT                               │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          Docker Compose                                      │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    Dev Container                                        │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Rust Toolchain                                                 │ │ │
│  │  │  - rustc, cargo                                                 │ │ │
│  │  │  - rustfmt, clippy                                               │ │ │
│  │  │  - cargo-watch, sqlx-cli                                         │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Node.js 20 + pnpm + NX                                          │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Development Tools                                                │ │ │
│  │  │  - PostgreSQL client                                             │ │ │
│  │  │  - Redis tools                                                   │ │ │
│  │  │  - grcov (coverage)                                               │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                       │ │
│  │  Volume Mount: /app (source code)                                    │ │
│  │  Env File: .env                                                      │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    PostgreSQL Database                                │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Port: 5432                                                      │ │ │
│  │  │  User: app                                                       │ │ │
│  │  │  Database: indexer_development                                    │ │ │
│  │  │  Volume: ./pgdata                                                 │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                        PRODUCTION ENVIRONMENT                                │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Container Orchestration (K8s/Docker Swarm)                │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    LISTENER POD                                        │ │
│  │                                                                         │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │ │
│  │  │  listener:1  │  │  listener:2  │  │  listener:N  │                │ │
│  │  │              │  │              │  │              │                │ │
│  │  │  Chain: ETH  │  │  Chain: POLY │  │  Chain: BASE │                │ │
│  │  │  Contracts:  │  │  Contracts:  │  │  Contracts:  │                │ │
│  │  │  - 0x1234... │  │  - 0x5678... │  │  - 0x9ABC... │                │ │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                │ │
│  │         │                 │                 │                          │ │
│  │         └─────────────────┴─────────────────┘                          │ │
│  │                           │                                               │ │
│  │                           │ Write                                         │ │
│  │                           ▼                                               │ │
│  └───────────────────────────┼───────────────────────────────────────────────┘ │
│                               │                                                 │
│  ┌───────────────────────────▼───────────────────────────────────────────────┐ │
│  │                    DATABASE POD                                            │ │
│  │                                                                             │ │
│  │  ┌──────────────────────────┐  ┌──────────────────────────┐              │ │
│  │  │  PostgreSQL Primary       │  │  PostgreSQL Replica      │              │ │
│  │  │                          │  │                          │              │ │
│  │  │  - Writes                │  │  - Reads                 │              │ │
│  │  │  - Transactions          │  │  - Queries              │              │ │
│  │  │  - Replication           │──>│  - Analytics            │              │ │
│  │  └──────────────────────────┘  └──────────────────────────┘              │ │
│  │                                                                             │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                    PROCESSOR POD                                          │ │
│  │                                                                             │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                    │ │
│  │  │ processor:1 │  │ processor:2 │  │ processor:N │                    │ │
│  │  │             │  │             │  │             │                    │ │
│  │  │ Batch: 25   │  │ Batch: 25   │  │ Batch: 25   │                    │ │
│  │  │ Concurrency │  │ Concurrency │  │ Concurrency │                    │ │
│  │  │ : High      │  │ : High      │  │ : High      │                    │ │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                    │ │
│  │         │                │                 │                              │ │
│  │         └────────────────┴─────────────────┘                              │ │
│  │                           │                                               │ │
│  │                           │ Read/Write                                    │ │
│  │                           ▼                                               │ │
│  └───────────────────────────┼───────────────────────────────────────────────┘ │
│                               │                                                 │
│                               ▼                                                 │
│                    ┌──────────────────────────┐                               │
│                    │   Database (Primary)      │                               │
│                    └──────────────────────────┘                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXTERNAL SERVICES                                        │
│                                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                       │
│  │ Ethereum RPC │  │ Polygon RPC │  │  Base RPC    │                       │
│  │              │  │              │  │              │                       │
│  │ HTTPS/WS     │  │ HTTPS/WS     │  │ HTTPS/WS     │                       │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                       │
│         │                 │                 │                                 │
│         └─────────────────┴─────────────────┘                                 │
│                           │                                                   │
│                           │ RPC Calls                                         │
│                           ▼                                                   │
│                  ┌─────────────────┐                                         │
│                  │  Listener Pods  │                                         │
│                  └─────────────────┘                                         │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Dockerfile Multi-Stage Build

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    DOCKERFILE STAGES                                         │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  STAGE 1: Development (dev)                                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Base: rust:latest                                                     │ │
│  │                                                                         │ │
│  │  Installed:                                                            │ │
│  │  ├─ PostgreSQL client                                                  │ │
│  │  ├─ Redis tools                                                        │ │
│  │  ├─ Rust tools (rustfmt, clippy, llvm-tools)                           │ │
│  │  ├─ Cargo tools (cargo-watch, sqlx-cli)                               │ │
│  │  ├─ Node.js 20 (via NVM)                                              │ │
│  │  ├─ pnpm, NX                                                           │ │
│  │  └─ grcov (coverage)                                                  │ │
│  │                                                                         │ │
│  │  Purpose: Full development environment                                 │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ Build
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STAGE 2: Build (build)                                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Base: rust:latest                                                     │ │
│  │                                                                         │ │
│  │  Process:                                                               │ │
│  │  1. Copy source code                                                    │ │
│  │  2. cargo build --release --bin ${APP_NAME}                            │ │
│  │                                                                         │ │
│  │  Output: Compiled binary                                                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                              │
                              │ Copy Binary
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STAGE 3: Production (prod)                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Base: debian:12.6                                                    │ │
│  │                                                                         │ │
│  │  Dependencies:                                                          │ │
│  │  ├─ libssl-dev                                                         │ │
│  │  ├─ build-essential                                                    │ │
│  │  ├─ curl                                                               │ │
│  │  └─ openssl                                                            │ │
│  │                                                                         │ │
│  │  Binary: /usr/local/bin/app (from build stage)                        │ │
│  │                                                                         │ │
│  │  Command: /usr/local/bin/app                                          │ │
│  │                                                                         │ │
│  │  Size: Minimal (only runtime dependencies)                            │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Contract Handler Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                    CONTRACT HANDLER SYSTEM                                   │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         Processor Service                                    │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    Contract Registry                                  │ │
│  │                                                                         │ │
│  │  Environment: CONTRACTS=usdt_erc20:0x1234...,uniswap:0x5678...       │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  HashMap<String, String>                                        │ │ │
│  │  │  Key:   Contract Address (lowercase hex)                        │ │ │
│  │  │  Value: Contract Name                                           │ │ │
│  │  │                                                                  │ │ │
│  │  │  Example:                                                        │ │ │
│  │  │  "0x1234..." -> "usdt_erc20"                                    │ │ │
│  │  │  "0x5678..." -> "uniswap_v3_factory"                             │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                         │ │
│  │  get_processor(address) -> ContractHandler                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│                              │                                                │
│                              │ Lookup                                         │
│                              ▼                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    ContractHandler Trait                              │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  Required Methods:                                               │ │ │
│  │  │                                                                  │ │ │
│  │  │  const NAME: &str                                               │ │ │
│  │  │  fn new(address: &str) -> Result<Self, AppError>                │ │ │
│  │  │  fn abi(&self) -> &JsonAbi                                      │ │ │
│  │  │  fn event_signature_to_name(...) -> Result<String, AppError>   │ │ │
│  │  │  fn process(...) -> Future<Result<(), AppError>>                │ │ │
│  │  │  fn handle_event(...) -> Future<Result<(), AppError>>          │ │ │
│  │  │                                                                  │ │ │
│  │  │  Default Implementation:                                        │ │ │
│  │  │  fn get_abi_for_contract(name: &str) -> Result<JsonAbi, ...>   │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│                              │                                                │
│                              │ Implement                                      │
│                              ▼                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    USDT ERC20 Handler                                 │ │
│  │                                                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │  NAME: "usdt_erc20"                                             │ │ │
│  │  │                                                                  │ │ │
│  │  │  ABI File: processor/artifacts/abi/usdt_erc20.json             │ │ │
│  │  │                                                                  │ │ │
│  │  │  Supported Events:                                               │ │ │
│  │  │  ├─ Transfer(address indexed from,                               │ │ │
│  │  │  │         address indexed to,                                    │ │ │
│  │  │  │         uint256 value)                                         │ │ │
│  │  │  └─ Approval(address indexed owner,                               │ │ │
│  │  │             address indexed spender,                              │ │ │
│  │  │             uint256 value)                                        │ │ │
│  │  │                                                                  │ │ │
│  │  │  Processing:                                                      │ │ │
│  │  │  1. Extract from/to from topics[1], topics[2]                   │ │ │
│  │  │  2. Extract value from data (uint256)                             │ │ │
│  │  │  3. Convert U256 to BigDecimal                                    │ │ │
│  │  │  4. Insert into usdt_transfers table                             │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│                              │                                                │
│                              │ Future Handlers                                │
│                              ▼                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    Future Implementations                             │ │
│  │                                                                         │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │ │
│  │  │ ERC721       │  │ ERC1155      │  │ Uniswap V3   │               │ │
│  │  │ Handler      │  │ Handler      │  │ Handler       │               │ │
│  │  │              │  │              │  │              │               │ │
│  │  │ - Transfer   │  │ - Transfer   │  │ - Swap       │               │ │
│  │  │ - Approval   │  │ - Approval   │  │ - Mint      │               │ │
│  │  │ - Mint       │  │ - Mint       │  │ - Burn      │               │ │
│  │  │ - Burn       │  │ - Burn       │  │              │               │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Error Handling Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        ERROR HANDLING ARCHITECTURE                           │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    LISTENER SERVICE ERRORS                                   │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Error Types:                                                          │ │
│  │  ├─ MissingEnvVar                                                       │ │
│  │  ├─ InvalidChainID                                                     │ │
│  │  ├─ Database(sqlx::Error)                                             │ │
│  │  ├─ RPCError(String)                                                   │ │
│  │  ├─ InvalidAddress(String)                                             │ │
│  │  └─ EVMLog(String)                                                     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Handling Strategy:                                                    │ │
│  │                                                                         │ │
│  │  MissingEnvVar ──────┐                                                 │ │
│  │  InvalidChainID ─────┼──> FATAL: Exit Service                          │ │
│  │                      │                                                 │ │
│  │  Database ───────────┼──> ROLLBACK Transaction                         │ │
│  │                      │    LOG Error                                    │ │
│  │                      │    CONTINUE (retry next iteration)               │ │
│  │                      │                                                 │ │
│  │  RPCError ───────────┼──> LOG Error                                    │ │
│  │                      │    CONTINUE (retry next iteration)              │ │
│  │                      │                                                 │ │
│  │  InvalidAddress ─────┼──> LOG Error                                    │ │
│  │  EVMLog ─────────────┘    CONTINUE (skip address)                      │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    PROCESSOR SERVICE ERRORS                                 │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Error Types:                                                          │ │
│  │  ├─ MissingEnvVar                                                       │ │
│  │  ├─ MissingContractAbiFile                                            │ │
│  │  ├─ InvalidAbi                                                         │ │
│  │  ├─ UnsupportedAddress                                                  │ │
│  │  ├─ UnsupportedContract                                                │ │
│  │  ├─ MissingEvent                                                       │ │
│  │  ├─ MissingEventHandler                                                 │ │
│  │  ├─ InvalidAddress                                                     │ │
│  │  ├─ EvmLogs(EvmLogsError)                                             │ │
│  │  ├─ Database(String)                                                   │ │
│  │  ├─ InvalidChainID                                                     │ │
│  │  └─ Sqlx(sqlx::Error)                                                 │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Handling Strategy:                                                    │ │
│  │                                                                         │ │
│  │  MissingEnvVar ──────┐                                                 │ │
│  │                      │                                                 │ │
│  │  MissingContractAbi ─┼──> FATAL: Exit Service                          │ │
│  │  InvalidAbi ─────────┤                                                 │ │
│  │                      │                                                 │ │
│  │  UnsupportedAddress ─┼──> LOG Error                                    │ │
│  │  UnsupportedContract─┤    SKIP Log (not registered)                   │ │
│  │  MissingEvent ───────┤                                                 │ │
│  │  MissingEventHandler─┤                                                 │ │
│  │                      │                                                 │ │
│  │  EvmLogs ────────────┼──> LOG Error                                    │ │
│  │  Database ───────────┤    KEEP Log (retry next poll)                  │ │
│  │  Sqlx ───────────────┘                                                 │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    TRANSACTION SAFETY                                        │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  LISTENER:                                                             │ │
│  │                                                                         │ │
│  │  BEGIN TRANSACTION                                                     │ │
│  │    ├─ INSERT evm_logs (log 1)                                          │ │
│  │    ├─ INSERT evm_logs (log 2)                                          │ │
│  │    ├─ INSERT evm_logs (log N)                                          │ │
│  │    ├─ UPDATE evm_sync_logs                                            │ │
│  │    │                                                                   │ │
│  │    └─ On Error: ROLLBACK (all or nothing)                             │ │
│  │                                                                         │ │
│  │  COMMIT TRANSACTION                                                    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  PROCESSOR:                                                            │ │
│  │                                                                         │ │
│  │  For each log (independent):                                          │ │
│  │    ├─ Process log                                                      │ │
│  │    ├─ Store processed data                                             │ │
│  │    │                                                                   │ │
│  │    └─ On Success: DELETE from evm_logs                                 │ │
│  │    └─ On Error: KEEP log (retry later)                                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Rate Limiting Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        RATE LIMITING SYSTEM                                   │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    LISTENER RATE LIMITING                                    │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Configuration Source:                                                │ │
│  │                                                                         │ │
│  │  Database: evm_chains.block_time                                       │ │
│  │  Example: Ethereum Mainnet = 12 seconds                                │ │
│  │           Polygon = 2 seconds                                          │ │
│  │           Base = 2 seconds                                              │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Tower Middleware:                                                     │ │
│  │                                                                         │ │
│  │  ServiceBuilder::new()                                                 │ │
│  │    .rate_limit(1, Duration::from_secs(block_time))                    │ │
│  │    .service(ListenerService { ... })                                   │ │
│  │                                                                         │ │
│  │  Effect:                                                               │ │
│  │  - Maximum 1 request per block_time seconds                           │ │
│  │  - Prevents RPC rate limit violations                                 │ │
│  │  - Respects chain-specific block times                                 │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Request Flow:                                                        │ │
│  │                                                                         │ │
│  │  Time: 0s    ──> Request 1 ──> [Allowed]                              │ │
│  │  Time: 5s    ──> Request 2 ──> [Blocked, wait]                       │ │
│  │  Time: 12s   ──> Request 2 ──> [Allowed]                              │ │
│  │  Time: 17s   ──> Request 3 ──> [Blocked, wait]                       │ │
│  │  Time: 24s   ──> Request 3 ──> [Allowed]                              │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    PROCESSOR POLLING                                         │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Configuration:                                                         │ │
│  │                                                                         │ │
│  │  Environment: POLL_INTERVAL (default: 10 seconds)                     │ │
│  │                                                                         │ │
│  │  Effect:                                                               │ │
│  │  - Sleeps POLL_INTERVAL seconds between polls                         │ │
│  │  - Reduces database load                                               │ │
│  │  - Balances latency vs. resource usage                                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Polling Flow:                                                        │ │
│  │                                                                         │ │
│  │  Time: 0s    ──> COUNT logs ──> Found 50 ──> Process batch            │ │
│  │  Time: 2s    ──> Processing...                                        │ │
│  │  Time: 5s    ──> Processing complete                                  │ │
│  │  Time: 5s    ──> Sleep 10 seconds                                    │ │
│  │  Time: 15s   ──> COUNT logs ──> Found 0 ──> Sleep 10 seconds         │ │
│  │  Time: 25s   ──> COUNT logs ──> Found 30 ──> Process batch           │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 11. File System Structure

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        PROJECT STRUCTURE                                     │
└──────────────────────────────────────────────────────────────────────────────┘

indexer-rs/
│
├── Cargo.toml                    # Workspace configuration
├── Cargo.lock                    # Dependency lock file
├── docker-compose.yml            # Docker services
├── Dockerfile                   # Multi-stage build
├── package.json                  # NX monorepo config
├── nx.json                      # NX configuration
├── README.md                    # Project documentation
├── ARCHITECTURE.md              # Architecture documentation
├── ARCHITECTURE_DIAGRAMS.md     # This file (ASCII diagrams)
│
├── libs/
│   └── indexer-db/              # Database library
│       ├── Cargo.toml
│       ├── src/
│       │   ├── lib.rs           # Database initialization
│       │   ├── entity.rs        # Entity module exports
│       │   └── entity/
│       │       ├── evm_chains.rs
│       │       ├── evm_logs.rs
│       │       ├── evm_sync_logs.rs
│       │       └── usdt_transfers.rs
│       └── migrations/          # SQLx migrations
│           ├── 20241203080313_create_evm_logs_table.sql
│           ├── 20241213065725_create_sync_logs_table.sql
│           ├── 20251218133955_create_usdt_transfers_table.sql
│           └── ...
│
├── listener/                    # Listener service
│   ├── Cargo.toml
│   ├── src/
│   │   ├── main.rs             # Entry point
│   │   ├── service.rs          # ListenerService
│   │   └── error.rs            # Error types
│   └── project.json            # NX project config
│
└── processor/                   # Processor service
    ├── Cargo.toml
    ├── src/
    │   ├── main.rs             # Entry point
    │   ├── service.rs          # Processing logic
    │   ├── error.rs            # Error types
    │   ├── utils.rs            # Utilities
    │   ├── contracts.rs        # Contract registry
    │   └── contracts/
    │       ├── contract_handler.rs  # Trait definition
    │       └── usdt.rs         # USDT handler
    ├── artifacts/
    │   └── abi/                # Contract ABI files
    │       └── usdt_erc20.json
    └── project.json            # NX project config
```

---

**Document Version**: 1.0  
**Last Updated**: 2025-01-27  
**Format**: ASCII Art Diagrams

